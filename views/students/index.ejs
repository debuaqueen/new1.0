<%- include('../partials/header') %>
<h1>All Students</h1>

<!-- Enhanced Search Form -->
<form action="/students" method="GET" class="search-form">
  <input type="text" name="name" placeholder="Name" value="<%= search.name || '' %>" />
  <input type="number" name="age" placeholder="Age" value="<%= search.age || '' %>" />
  <input type="text" name="course" placeholder="Course" value="<%= search.course || '' %>" />
  <input type="tel" name="tele" placeholder="Phone" value="<%= search.tele || '' %>" />
  <input type="number" step="0.1" name="minGPA" placeholder="Min GPA" value="<%= search.minGPA || '' %>" />
  <div class="pg-filter">
    <label>Type:</label>
    <button type="submit" name="isPG" value="true" class="<%= search.isPG==='true'?'active':'' %>">Graduate</button>
    <button type="submit" name="isPG" value="false" class="<%= search.isPG==='false'?'active':'' %>">Undergraduate</button>
  </div>
  <button type="submit">Search</button>
  <a href="/students" class="btn-clear">Clear</a>
</form>

<!-- CSV Export Button -->
<a href="/students/csv" class="btn-export">Export to CSV</a>

<ul class="student-list">
  <% if (students.length === 0) { %>
    <p>No students found.</p>
  <% } else { %>
    <% students.forEach(s => { %>
      <li class="student-item">
        <div class="info">
          <strong><%= s.name %></strong> (ID: <%= s.studentId %>)<br>
          <%= s.age %>yo | <%= s.course %> | <%= s.tele %><br>
          GPA: <%= s.gpa %> | <%= s.isPG ? 'Graduate' : 'Undergraduate' %>
        </div>
        <div class="actions">
          <a href="/students/<%= s._id %>/edit" class="btn-edit">Edit</a>
          <button onclick="showDeleteModal('<%= s._id %>', '<%= s.name %>')" class="delete-btn">Delete</button>
        </div>
      </li>
    <% }) %>
  <% } %>
</ul>

<!-- Fancy Delete Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <p>Delete <strong id="deleteName"></strong>?</p>
    <button onclick="confirmDelete()" class="btn-danger">Yes, Delete</button>
    <button onclick="closeModal()" class="btn-cancel">Cancel</button>
  </div>
</div>

<style>
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
.modal-content { background: white; padding: 20px; border-radius: 8px; text-align: center; }
.btn-export { display: inline-block; background: #27ae60; color: white; padding: 8px 16px; border-radius: 4px; text-decoration: none; margin: 10px 0; }
.btn-clear { margin-left: 10px; color: #e74c3c; text-decoration: underline; }
.btn-danger { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px; }
.btn-cancel { background: #95a5a6; color: white; }
</style>

<script>
let deleteId = '';
function showDeleteModal(id, name) {
  deleteId = id;
  document.getElementById('deleteName').textContent = name;
  document.getElementById('deleteModal').style.display = 'flex';
}
function closeModal() {
  document.getElementById('deleteModal').style.display = 'none';
}
function confirmDelete() {
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/students/' + deleteId + '?_method=DELETE';
  document.body.appendChild(form);
  form.submit();
}
</script>

<%- include('../partials/footer') %>
